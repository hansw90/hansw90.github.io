---
title: "JAVA. Transaction, Commit, Rollback"
date: 2023-02-19-00:00:00 -0000
categories: JAVA

---

남궁성님의 스프링 정석 : 남궁성과 끝까지 간다를 정리한 내용입니다. 

## 1. 트랜잭션이란?
먼저 Transaction 이 무엇인지 알아보자.

```
트랜잭션(Transaction)이란
간단히는 더이상 나눌 수 없는 작업의 단위
데이터베이스에서 논리적 상태 변화, 즉 Insert, Update, Delet로 데이터베이스의 데이터가 변화가 있는 것을 트랜잭션이라 한다.
데이터의 변화가 많은 테이블을 트랜잭션 테이블이라 하고, 그렇지 않은 것을 마스터 테이블이라 한다.
```


## 2. 트랜잭션의 속성 (ACID)
- Atomicity(원자성)
    - 나눌수 없는 하나의 작업으로 이루어져야 한다 .
- Consistency(일관성)
    - Tx 수행 전과 후가 일관된 상태를 유지해야한다.
- Isolation(고립성)
    - 각 Tx는 독립적으로 수행되어야 한다.
    - Isolation Level 을 적절히 조절해야 한다.
- Durability(영속성)
    - 성공한 Tx의 결과는 유지되어야 한다.

## 3. 커밋과 롤백
- Commit(커밋)
    - 작업한 내용을 DB에 영구히 저장한다.
    - 자동커밋
        - Default 값이 1 이다.
        - 명령 실행 후, 자동으로 커밋이 수행 (rollback 불가)
    - 수동커밋
        - Set autocommit (0) 을 통해 변경
        - 명령 실행 후, 명시적으로 commit 또는 rollback 을 입력
- Lollback(롤백)
    - 최근 변경 사항을 취소(__마지막 커밋으로 복귀__)


## 4. Tx의 Isolation Level 
아래 4개의 격리수준중 아래로 갈수록 트랜잭션 간의 데이터 격리(고립) 정도가 높아지며, 동시성 처리 성능이 떨어진다.

1. READ UNCOMMITED
    - 커밋되지 않은 데이터도 읽기 가능
    - Dirty Reead 발생
        - 다른사람이 손을 대서 더러워짐을 뜻함,,
        - 더티 리드란 다른 트랜잭션에서 처리한 작업이 완료되지 않았음에도, 다른 트랜잭션에서 볼수 있게 되는 현상을 말한다.
2. READ COMMITTED
    - Phantom Read 발생
    - 커밋된 데이터만 읽기 가능
    - 온라인 서비스에서 가장 많이 사용되는 격리수준
    - NON-REPEATABLE READ 발생
        - 하나의 트랜잭션 내에서 동일한 SELECT 쿼리를 실행했을 때 항상 같은 결과를 보장해야 한다는 REPEATABLE READ 정합성에 어근사는 것을 말함
    - 오라클 기본 격리수준
3. REPEATABLE READ (기본값)
    - Tx이 시작된 이후 변경은 무시된다.
    - 반복해서 읽기 가능
    - InnoDb 스토리지 엔진 기본 격리 수준
    - Phantom Read 발생
        - 첫 번째 쿼리에서는 없었던 레코드가 두분째 쿼리에서는 존재하는 것처럼 보이는 현상을 말한다. (Repeatable Read 나 ReadCommited 격리 수준에서 발생할 수 있음)
4. SERIALIZBLE
    - 격리수준이 가장 높음
    - 한번에 하나의 Tx만 독립적으로 수행.
    - 직렬 처리를 하여 데이터의 일관성과 무결성을 보장할 수 있지만, 서비스 성능(처리량이 많은)이 많이 떨어진다.


## 5. Transaction Test
```java
public void transcationTest() throws Exception {
    Connection conn = null;
    try {
        conn = ds.getConnection();
        conn.setAutoCommit(false); // auto commit 을 false 로 해두어라

        String sql = "insert into test (id, pw) values (?, ?)"; // id 는 pk

        PreparedStatement pstmt = conn.prepareStatement(sql);
        pstmt.setString(1, "han");
        pstmt.setString(2, "sw");

        int rowCnt = pstmt.executeUpdate(); // insert, delete, update
        pstmt.setString(1, "han")
        rowCnt = pstmt.executeUpdate;
        conn.commit();
    } catch(Exception e) {
        conn.rollback();
    }
}
```

-- 참고 [데이터베이스 MySQL 트랜잭션 격리 수준](https://steady-coding.tistory.com/562)
