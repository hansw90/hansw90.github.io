---
title: "자바 (23). Mybatis와 SqlSession 그리고 commit 이야기" 
date: 2021-02-17 23:41
categories: Java
---

문제 없이 잘 진행되던 이기종 동기화 작업중, 큰 문제?가 발생하였다. !!!
음 뭐 여기다 적어서 뭐하나 싶긴하지만,,

문제는 이러했다. 이기종간의 테이블 싱크를 맞추면서 upsert를 하더라도 벌크 upsert로 진행하면 그렇게 큰 문제는 되지 않는걸 확인하였다. 
(2000만 건이 넘는 데이터도 크게 무리는 없었으니깐,,)

문제는 삭제에 관한것이였다. 2000만건(하루 2억 row) 의 데이터를 삭제 하기 위해선 어떻게 해야 할까?? 마냥 비교는 답이 없으려나?? 

완벽한 해결책은 아직 없다, 그냥 여기다 고민한 내용을 끄적일까 하여 기록해 본다...

일단 팀장님한테 컨펌을 받아야 해서,,

오랜만에 개떡같던 내 자바코드를 보니 반갑기도 하면서 나도 다시 모르겠더라,, 

무튼 시작해보도록 하자

### 0. 목차

1. 기존의 방법
2. Hash key 비교 
3. 해당 Table값 Delete Insert
    - sqlSession auto commit
    - MySQl lock

### 1. 기존의 방법

기존의 방법은 이러하였다.

원본(오라클db) 에서 2000만 건의 데이터를 Upsert 이후 number type 인 index를 하나 골라 min,max 값을 가져온다. 

그 이후 동기화가 필요한 MysqlDB에서 그 min 보다 작은 itm_index들을 삭제 max값보다 큰 itm_index값을 삭제 하는 방식으로 동기화를 시켰다

그런데,, 이 중간 값이 갑자기 삭제 된다면 어떻게 처리를 해야 할까?.

이러한 방법으론 정합성을 지키기가 많이 힘들었다. 

그래서 생각한 방법은 이러하였다.

### 2. Hash Key 비교

이미 이번 프로젝트에서 Hash Key를 통한 비교는 여러곳에서 사용이 되었다.

그렇기 때문에 내가 가장먼저 생각한 방법은 HashKey 비교였었다.

HashKey를 사용하였을때, 검색에 필요한 연산은 
20,000,000 x log2(20,000,000) ~= 480,000,000 (~ 5억 연산정도?) 번  

이정도 라면 해볼만 하다고 생각하였다. 

아래는 대충 어떻게 할지에 대한 테스트 코드이다. 


### 3. 해당 테이블값 delete & insert

