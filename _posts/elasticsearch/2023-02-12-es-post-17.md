Ej---
title: "엘라스틱서치에서 score normalization"
date: 2023-02-13-00:00:00 -0000
categories: ELASTICSEARCH
---

이전에 스코어를 컨트롤하는 방법을 다뤄본적이 있다. 
하지만, 실제로 서비스를 만들다보면, 이것만으로는 충분하지 않을떄가 있다.
(문서 내의 단어의 빈도를 가지고 검색엔진의 점수를 컨트롤 하는건 생각보다 쉬운인일이 아니다..)

그럴떄 나는 점수를 정규화 하여 스코어를 사용할떄가 있는데, 이 정규화 방법에 대해 알아보자.

## 차례
1. 도입전E
4. score nomalization
  - constant score
5. example


## 1. 도입전

이번 테스트에선 아래와 같은 데이터를 사용한다.

```json
POST _bulk
{ "index" : { "_index" : "poi_example", "_id" : "1" } }
{ "target_poi_name" : "신당동 떡볶이", "target_dong_name": null, "like": 0}
{ "index" : { "_index" : "poi_example", "_id" : "2" } }
{ "target_poi_name" : "우체국", "target_dong_name": "신당동", "like": 0}
{ "index" : { "_index" : "poi_example", "_id" : "3" } }
{ "target_poi_name" : "휴먼시아", "target_dong_name": "신당동", "like": 0}
{ "index" : { "_index" : "poi_example", "_id" : "4" } }
{ "target_poi_name" : "떡볶이집", "target_dong_name": "신당동", "like": 0}
{ "index" : { "_index" : "poi_example", "_id" : "5" } }
{ "target_poi_name" : "신당동 떡볶이", "target_dong_name": "중앙동", "like": 0}
{ "index" : { "_index" : "poi_example", "_id" : "6" } }
{ "target_poi_name" : "우체국", "target_dong_name": "중앙동", "like": 0}
{ "index" : { "_index" : "poi_example", "_id" : "7" } }
{ "target_poi_name" : "신당역", "target_dong_name": "신당동", "like": 0}
{ "index" : { "_index" : "poi_example", "_id" : "8" } }
{ "target_poi_name" : "신당초등학교", "target_dong_name": "신당동", "like": 0}
{ "index" : { "_index" : "poi_example", "_id" : "10" } }
{ "target_poi_name" : "엽기 떡볶이", "target_dong_name": "신당동", "like": 0}
{ "index" : { "_index" : "poi_example", "_id" : "11" } }
{ "target_poi_name" : "신당동 태권도", "target_dong_name": null, "like": 0}
{ "index" : { "_index" : "poi_example", "_id" : "12" } }
{ "target_poi_name" : "신당동 태권도", "target_dong_name": null, "like": 0}

```

target_poi_name 필드에만 nori analyzer를 적용하였고, 나머진 그냥 타입 자동생성을한 필드이다.
(__id 1번__은 같이 다른 document와는 다르게 target_dong_name 값이 null인걸 기억하자.)

위의 document 들중 내가 원하는 장소를 검색했을때, 올바른 결과를 내기 위한 검색 쿼리를 만들어 보도록 하자.

나는 신당동 즉석 떡볶이를 굉장히 좋아하기 때문에, 신당동 떡볶이를 검색한다고 생각해보자,

그럼 굉장히 직관적인 방법으로 아래와 같이 검색을 하면, 내가 원하는 결과를 얻을수 있을것이다.

```json
GET poi_example/_search
{
  "query": {
    "multi_match": {
      "query": "신당동 떡볶이",
      "fields": ["target_poi_name", "target_dong_name"]
    }
  }
}

// response 
"hits" : {
    "total" : {
      "value" : 10,
      "relation" : "eq"
    },
    "max_score" : 10.304594,
    "hits" : [
      {
        "_index" : "poi_example",
        "_type" : "_doc",
        "_id" : "1",
        "_score" : 10.304594,
        "_source" : {
          "target_poi_name" : "신당동 떡볶이",
          "target_dong_name" : null,
          "like" : 0
        }
      },
      {
        "_index" : "poi_example",
        "_type" : "_doc",
        "_id" : "2",
        "_score" : 10.304594,
        "_source" : {
          "target_poi_name" : "신당동 떡볶이",
          "target_dong_name" : "중앙동",
          "like" : 0
        }
      }
    ]
}
```

1차적으론 성공이다. 그런데, 다른동에 대해서도 점수가 같은걸 볼수 있다.
bool query를 통해, 각각의 동에대한 점수 반영을 해보도록 하자. (처음 내가 적용했던 방법)

```json
GET poi_example/_search
{
  "query": {
    "bool": {
      "must": [
        {
          "match": {
            "target_poi_name": "신당동 떡볶이"
          }
        }
      ],
      "should": [
        {
          "match": {
            "target_dong_name": "중앙동"
          }
        }
      ]
    }
  }
}

// response
"hits" : [
  {
    "_index" : "poi_example",
    "_type" : "_doc",
    "_id" : "2",
    "_score" : 10.147953,
    "_source" : {
      "target_poi_name" : "신당동 떡볶이",
      "target_dong_name" : "중앙동",
      "like" : 0
    }
  }
  ]
```
완벽하지 않은가?? 

근데 내가 매장을 찾는게 아닌, 집에서 먹으려고 집주소를 검색한다 해보자,

그런데 아파트와 같은 명칭을 가진 아파트가 체인점 이름보다 압도적으로 많다. 이때 검색이 우리가 원하는데로 될까?
```json
{ "index" : { "_index" : "poi_example", "_id" : "10" } }
{ "target_poi_name" : "휴먼시아", "target_dong_name": "신당동", "like": 0}
{ "index" : { "_index" : "poi_example", "_id" : "11" } }
{ "target_poi_name" : "휴먼시아", "target_dong_name": "서교동", "like": 0}
{ "index" : { "_index" : "poi_example", "_id" : "12" } }
{ "target_poi_name" : "휴먼시아", "target_dong_name": "합정동", "like": 0}
{ "index" : { "_index" : "poi_example", "_id" : "13" } }
{ "target_poi_name" : "휴먼시아", "target_dong_name": "서초동", "like": 0}
{ "index" : { "_index" : "poi_example", "_id" : "14" } }
{ "target_poi_name" : "휴먼시아", "target_dong_name": "중원동", "like": 0}
{ "index" : { "_index" : "poi_example", "_id" : "15" } }
{ "target_poi_name" : "휴먼시아", "target_dong_name": "중앙동", "like": 0}
{ "index" : { "_index" : "poi_example", "_id" : "16" } }
{ "target_poi_name" : "휴먼시아", "target_dong_name": "금광동", "like": 0}
{ "index" : { "_index" : "poi_example", "_id" : "17" } }
{ "target_poi_name" : "휴먼시아", "target_dong_name": "판교동", "like": 0}
{ "index" : { "_index" : "poi_example", "_id" : "18" } }
{ "target_poi_name" : "휴먼시아", "target_dong_name": "강호동", "like": 0}
{ "index" : { "_index" : "poi_example", "_id" : "19" } }
{ "target_poi_name" : "휴먼시아", "target_dong_name": "신림동", "like": 0}
{ "index" : { "_index" : "poi_example", "_id" : "20" } }
{ "target_poi_name" : "휴먼시아", "target_dong_name": "마포동", "like": 0}
{ "index" : { "_index" : "poi_example", "_id" : "21" } }
{ "target_poi_name" : "휴먼시아", "target_dong_name": "공덕동", "like": 0}
```


```json
GET poi_example/_search
{
  "size": 3,
  "query": {
    "bool": {
      "must": [
        {
          "match": {
            "target_poi_name": "신당동 휴먼시아"
          }
        }
      ],
      "should": [
        {
          "match": {
            "target_dong_name": "신당동"
          }
        }
      ]
    }
  }
}
```

response
```json
{
    "_index" : "poi_example",
    "_type" : "_doc",
    "_id" : "6",
    "_score" : 4.1653147,
    "_source" : {
      "target_poi_name" : "신당동 유치원",
      "target_dong_name" : null,
      "like" : 0
    }
  },
  {
    "_index" : "poi_example",
    "_type" : "_doc",
    "_id" : "1",
    "_score" : 3.9953568,
    "_source" : {
      "target_poi_name" : "신당동 떡볶이",
      "target_dong_name" : null,
      "like" : 0
    }
  },
  {
    "_index" : "poi_example",
    "_type" : "_doc",
    "_id" : "2",
    "_score" : 3.9953568,
    "_source" : {
      "target_poi_name" : "신당동 떡볶이",
      "target_dong_name" : "중앙동",
      "like" : 0
    }
  }
```
어??.. 결과가 없다. 마지막에 뭉텅이로 추가한 휴먼시아 아파트들이, 신당동 보다 우선순위가 많이 밀려 이런생기게 되었다.

이렇듯, 단순히 compound query 만으로는 풀지 못하는 문제들이 생길수 있다. 

내가 진행한 프로젝트에선, 단순히 단일 검색을 하는게 아닌 context 가 유지되면서 계속해서 검색이 유지되어야 하는 기능도 필요했기에 더더욱 query에 대한 튜닝이 필요하였다. 

이제 그 튜닝 방법을 간단히 소개 해보도록 하겠다.


## 2. score nomalization


